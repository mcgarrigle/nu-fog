#cloud-config
ssh_pwauth: true
users:
  - name: ${USER}
    groups: users
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    ssh_authorized_keys:
    - ${SSH_PUBLIC_KEY}
chpasswd:
  expire: false
  users:
  - { name: ${USER}, password: ${PASSWORD}, type: text }    

# configure SSH certificates

write_files:
- path: /etc/ssh/sshd_config.d/10-ssh-certs.conf
  content: "TrustedUserCAKeys /etc/ssh/user_ca_key.pub"
  owner: root:root
  permissions: '0644'
- path: /etc/ssh/user_ca_key.pub
  content: "${SSH_USER_CA_KEY}"
  owner: root:root
  permissions: '0644'
